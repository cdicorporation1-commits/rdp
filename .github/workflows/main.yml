# .github/workflows/rustdesk.yml
name: ğŸ–¥ï¸ RustDesk Desktop (Web-Accessible)

on:
  workflow_dispatch:
    inputs:
      rustdesk_id:
        type: string
        description: 'RustDesk ID personalizado (opcional)'
        required: false
      rustdesk_password:
        type: string
        description: 'ContraseÃ±a personalizada (opcional)'
        required: false

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 360  # MÃ¡ximo permitido

    steps:
      - name: ğŸ”½ Descargar RustDesk
        run: |
          curl -L https://github.com/rustdesk/rustdesk/releases/download/1.2.4/rustdesk-1.2.4-x86_64.exe -o rustdesk.exe

      - name: ğŸš€ Instalar y ejecutar
        shell: pwsh
        run: |
          Start-Process -FilePath ".\rustdesk.exe" -ArgumentList "--silent-install" -Wait
          Start-Sleep 10

      - name: ğŸ“¡ Configurar credenciales
        id: creds
        shell: pwsh
        run: |
          $id = "${{ github.event.inputs.rustdesk_id }}"
          $pw = "${{ github.event.inputs.rustdesk_password }}"

          if (!$id) { $id = "GH$(Get-Date -Format 'HHmmss')" }
          if (!$pw) { $pw = "Pass$(Get-Random -Minimum 10000 -Maximum 99999)!" }

          $config = @"
            id = "$id"
            password = "$pw"
            encrypted = false
          "@

          $dir = "$env:APPDATA\RustDesk\config"
          New-Item -ItemType Directory -Path $dir -Force
          Set-Content -Path "$dir\RustDesk.toml" -Value $config

          # Reiniciar RustDesk
          Get-Process rustdesk -ErrorAction SilentlyContinue | Stop-Process
          Start-Sleep 5
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"

          # ğŸ‘‡ ESTO ES CLAVE: exportar valores para usarlos despuÃ©s
          echo "rustdesk_id=$id" >> $env:GITHUB_OUTPUT
          echo "rustdesk_password=$pw" >> $env:GITHUB_OUTPUT

      - name: ğŸ“¢ Â¡TUS CREDENCIALES!
        run: |
          echo "=================================================="
          echo "âœ… Â¡ESCRITORIO REMOTO ACTIVO!"
          echo "--------------------------------------------------"
          echo "ğŸ†” RustDesk ID:     ${{ steps.creds.outputs.rustdesk_id }}"
          echo "ğŸ”‘ ContraseÃ±a:      ${{ steps.creds.outputs.rustdesk_password }}"
          echo "--------------------------------------------------"
          echo "ğŸ‘‰ ConÃ©ctate desde: https://rustdesk.com"
          echo "â±ï¸  Vigente ~6 horas (lÃ­mite de GitHub Actions)"
          echo "=================================================="

      - name: ğŸ”„ Mantener vivo
        shell: pwsh
        run: |
          $end = (Get-Date).AddMinutes(350)
          while ((Get-Date) -lt $end) {
            if (!(Get-Process rustdesk -ErrorAction SilentlyContinue)) {
              Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
            }
            Start-Sleep 300
          }
