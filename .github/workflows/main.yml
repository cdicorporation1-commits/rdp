name: WINDOWS RDP + RUSTDESK - TIEMPO ILIMITADO

on:
  workflow_dispatch:
    inputs:
      rustdesk_id:
        type: string
        description: 'RustDesk ID (opcional)'
        required: false
      rustdesk_password:
        type: string
        description: 'RustDesk Password (opcional)'
        required: false

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: üîΩ Descargar RustDesk y Archivos
        run: |
          Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/download/1.2.3/rustdesk-1.2.3-x86_64.exe -OutFile rustdesk.exe

      - name: üöÄ Instalar y Configurar RustDesk
        shell: pwsh
        run: |
          Start-Process -FilePath ".\rustdesk.exe" -ArgumentList "--silent-install" -Wait
          Start-Sleep -Seconds 10
          
          $rustdeskPath = "C:\Program Files\RustDesk\rustdesk.exe"
          if (Test-Path $rustdeskPath) {
              $WshShell = New-Object -comObject WScript.Shell
              $Shortcut = $WshShell.CreateShortcut("$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup\RustDesk.lnk")
              $Shortcut.TargetPath = $rustdeskPath
              $Shortcut.WorkingDirectory = "C:\Program Files\RustDesk"
              $Shortcut.Save()
              Start-Process -FilePath $rustdeskPath
          }
          Start-Sleep -Seconds 10

      - name: üîß Configurar RustDesk v√≠a Registro y Optimizar SO
        shell: pwsh
        run: |
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "auto-start" /t REG_DWORD /d 1 /f
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "allow-auto-update" /t REG_DWORD /d 0 /f
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "disable-audio" /t REG_DWORD /d 0 /f
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "lock-after-session-end" /t REG_DWORD /d 0 /f
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "show-remote-cursor" /t REG_DWORD /d 1 /f
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "screen-resolution" /t REG_SZ /d "1920x1080" /f
          reg add "HKEY_CURRENT_USER\Software\RustDesk" /v "quality" /t REG_SZ /d "balanced" /f
          
          reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" /v NoAutoUpdate /t REG_DWORD /d 1 /f
          powercfg /h off
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          netsh advfirewall firewall add rule name="RustDesk" dir=in action=allow program="C:\Program Files\RustDesk\rustdesk.exe" enable=yes

      - name: üë§ Crear Usuario y Configurar Contrase√±a RDP
        shell: pwsh
        run: |
          $username = "rustuser"
          $password = "RustDesk#2024!"
          New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "RustDesk User" -Description "Remote Access User"
          Add-LocalGroupMember -Group "Administrators" -Member $username

      - name: üì° Configurar ID y Contrase√±a de RustDesk
        shell: pwsh
        run: |
          $rustdeskConfigDir = "$env:APPDATA\RustDesk\config"
          $rustdeskConfigPath = "$rustdeskConfigDir\RustDesk.toml"
          $customId = "${{ github.event.inputs.rustdesk_id }}"
          $customPassword = "${{ github.event.inputs.rustdesk_password }}"
          
          if (-not $customId) {
              $customId = "GH" + (Get-Date -Format "HHmmss")
          }
          if (-not $customPassword) {
              $customPassword = "Rust" + (Get-Random -Minimum 1000 -Maximum 9999) + "!"
          }
          
          $configContent = @"
encrypted = true
id = "$customId"
password = "$customPassword"
"@
          New-Item -ItemType Directory -Path $rustdeskConfigDir -Force
          Set-Content -Path $rustdeskConfigPath -Value $configContent
          
          Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue | Stop-Process -Force
          Start-Sleep -Seconds 5
          Start-Process -FilePath "C:\Program Files\RustDesk\rustdesk.exe"

      - name: üì¢ Mostrar Informaci√≥n de Conexi√≥n
        shell: pwsh
        run: |
          $customId = "${{ github.event.inputs.rustdesk_id }}"
          $customPassword = "${{ github.event.inputs.rustdesk_password }}"
          
          if (-not $customId) {
              $customId = "GH" + (Get-Date -Format "HHmmss")
          }
          if (-not $customPassword) {
              $customPassword = "Rust" + (Get-Random -Minimum 1000 -Maximum 9999) + "!"
          }
          
          Write-Host "=========================================="
          Write-Host "üöÄ RUSTDESK CONFIGURADO"
          Write-Host "=========================================="
          Write-Host "üÜî RustDesk ID: $customId"
          Write-Host "üîë RustDesk Password: $customPassword"
          Write-Host "üë§ Usuario Windows: rustuser"
          Write-Host "üîê Contrase√±a Windows: RustDesk#2024!"
          Write-Host "‚è∞ Duraci√≥n M√°xima: 6 Horas (por restricci√≥n de GitHub)"
          Write-Host "=========================================="

      - name: üîÑ Bucle de Mantenimiento Infinito
        shell: pwsh
        run: |
          while ($true) {
              $currentTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              
              if (-not (Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue)) {
                  Write-Host "üîÑ Reiniciando RustDesk... $(Get-Date)"
                  Start-Process -FilePath "C:\Program Files\RustDesk\rustdesk.exe"
                  Start-Sleep -Seconds 10
              }
              
              Write-Host "üîÑ Manteniendo la conexi√≥n activa... $currentTime"
              Start-Sleep -Seconds 300
          }
